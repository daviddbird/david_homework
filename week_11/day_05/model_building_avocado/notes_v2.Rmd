---
title: "R Notebook"
output: html_notebook
---

#1 MVP
We’ve looked at a few different ways in which we can build models this week, including how to prepare them properly. This weekend we’ll build a multiple linear regression model on a dataset which will need some preparation. The data has come from Kaggle and can be found in the data folder.

We want to model avocado sales. You’ll need to identify the target variable and use the tools we’ve worked with this week in order to prepare your dataset and find appropriate predictors. Once you’ve built your model use the validation techniques discussed on Wednesday to evaluate it.

#2 Extensions
Build a decision tree to model the likelihood of a sale being of an organic avocado.
Use k-means clustering to investigate potential relationships between the year and the average avocado price.


```{r}
library(tidyverse)
#loading in data
avocado <- read.csv("data/avocado.csv")
```


```{r}
# investigate structure and summary of data
str(avocado)
summary(avocado)
```

```{r}
# check for missing values
apply(avocado, 2, function(x) any(is.na(x) | is.infinite(x) | is.null(x)))
```


```{r}
# get rid of spaces in column names
names(avocado) <- make.names(names(avocado))
```

```{r}
# make all colum names lower case
for( i in colnames(avocado)) {
  colnames(avocado)[which(colnames(avocado) == i)] = tolower(i)
}

avocado
```

```{r}
library(lubridate)
avocado$year <- year(ymd(as.character(avocado$date)))
```

```{r}
avocado$month <- month(ymd(as.character(avocado$date)))
```

```{r}
avocado$week <- week(ymd(as.character(avocado$date)))
```


```{r}
glimpse(avocado)
```


```{r}
avocado %>%
  ggplot(aes(x = averageprice)) +
  geom_histogram() +
  facet_wrap(~ year)
# seems to be less data in 2018 compared to other years 

#table(avocado$year)
```

```{r}
avocado %>%
  ggplot(aes(x = averageprice)) +
  geom_histogram() +
  facet_wrap(~ month)

#table(avocado$month)
```

```{r}
avocado %>%
  ggplot(aes(x = averageprice)) +
  geom_histogram() +
  facet_wrap(~ week)

#table(avocado$week)
```

```{r}
avocado %>%
  ggplot(aes(x = as.factor(year), y = averageprice, group = year)) +
  geom_boxplot()
```

```{r}
avocado %>%
  ggplot(aes(x = as.factor(month), y = averageprice, group = month)) +
  geom_boxplot()
```

```{r}
avocado %>%
  ggplot(aes(x = as.factor(type), y = averageprice)) +
  geom_boxplot() +
  coord_flip()
#must greater spread of prices for organic
```

```{r}
var(avocado$averageprice)
mean(avocado$averageprice)
sd(avocado$averageprice)

#assuming normally distributed averageprice
#approx 68 percent of avocados in our data sold at prices between $1.405978 - $0.4026766 = $1.003302 and $1.405978 + $0.4026766 = $1.808655
```
```{r}
mean(avocado$averageprice) - sd(avocado$averageprice)
mean(avocado$averageprice) + sd(avocado$averageprice)
```

```{r}
avocado %>%
  ggplot(aes(x = averageprice)) +
  geom_histogram()
```


```{r}
avocado %>%
  ggplot(aes(x = averageprice)) +
  geom_histogram() +
  facet_wrap(~ type)
#more conventional than organic sold but at generally lower price.
```



```{r}
avocado %>%
  ggplot(aes(x = region, y = averageprice, color = as.factor(year))) +
  geom_point() +
  coord_flip() +
  facet_wrap(~ year)
# great deal of variability of price around region
```

```{r}
avocado %>%
  ggplot(aes(x = region, y = averageprice, color = as.factor(month))) +
  geom_point() +
  coord_flip() +
  facet_wrap(~ month)
# great deal of variability of price around region
```


```{r}
avocado %>%
  ggplot(aes(x = region, y = averageprice, color = as.factor(year))) +
  geom_point() +
  coord_flip() +
  facet_wrap(~ type)

# and variability around year too
```

```{r}
avocado %>%
  ggplot(aes(x = ymd(as.character(avocado$date)), y = averageprice, color = type)) +
  geom_line() +
  facet_wrap(~ type, ncol = 1)

```


```{r}
region_table <- table(avocado$region)
round(prop.table(region_table) *100, digits = 1)
```

```{r}
type_table <- table(avocado$type)
round(prop.table(type_table) * 100, digits = 1)
```

```{r}
table(avocado$year)
```


```{r}
summary(avocado)
```

```{r}
library(psych)
```
```{r}
pairs.panels(avocado[c("averageprice", "x4046", "x4225", "x4770", "small.bags", "large.bags", "xlarge.bags", "type", "region", "month", "week", "year")])
```
```{r}
summary(avocado)
```

```{r}
# tidy up data
avocado_tidy <- avocado %>%
  select(-c("x", "date", "total.volume", "total.bags"))

glimpse(avocado_tidy)
# x is just reference so no predictive power, taken out date as I have year, week and month. total.volume and total.bags can be derived
# from the other data
```

```{r}
# changing type to logical as there are only two types of avocado - didn't bother with this as noticed the model did all of this automatically.
#avocado_tidy$is.organic <- with(avocado_tidy, type=="organic")
```

```{r}
# using alias to check is there are any aliased vairables | this result (I assume) means no aliased variables
alias(averageprice ~ ., data = avocado_tidy)
```

```{r}
avocado_tidy %>%
  ggplot(aes(x = averageprice, y = type)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)
```


```{r}
library(caret)
```

```{r}
# using K-fold cross validation
# using 10 folds
# first model has everything included!
cv_10_fold <- trainControl(method = "cv", number = 10, savePredictions = TRUE)

model <- train(averageprice ~ ., data = avocado_tidy,
               trControl = cv_10_fold,
               method = "lm")
```

```{r}
model$pred
```

```{r}
model$resample
```

```{r}
mean(model$resample$RMSE)
```

```{r}
mean(model$resample$Rsquared)
```

```{r}
summary(model)
```
```{r}
model <- lm(averageprice ~ ., data = avocado_tidy)
par(mfrow = c(2, 2))
plot(model)
```


looking for a lower error (RMSE) and a higher R squared value
```{r}
cv_10_fold <- trainControl(method = "cv", number = 10, savePredictions = TRUE)

model1 <- train(averageprice ~ type + region, 
                data = avocado_tidy,
                trControl = cv_10_fold,
                method = "lm")

mean(model1$resample$RMSE)
mean(model1$resample$Rsquared)
```
wrong direction



```{r}
cv_10_fold <- trainControl(method = "cv", number = 10, savePredictions = TRUE)

model2 <- train(averageprice ~ type, 
                data = avocado_tidy,
                trControl = cv_10_fold,
                method = "lm")

mean(model2$resample$RMSE)
mean(model2$resample$Rsquared)
```
even worse

```{r}
cv_10_fold <- trainControl(method = "cv", number = 10, savePredictions = TRUE)

model3 <- train(averageprice ~ type + month, 
                data = avocado_tidy,
                trControl = cv_10_fold,
                method = "lm")

mean(model3$resample$RMSE)
mean(model3$resample$Rsquared)
```
error reduced slightly and R squared increased

```{r}
cv_10_fold <- trainControl(method = "cv", number = 10, savePredictions = TRUE)

model4 <- train(averageprice ~ type + year + region + week + month, 
                data = avocado_tidy,
                trControl = cv_10_fold,
                method = "lm")

mean(model4$resample$RMSE)
mean(model4$resample$Rsquared)
```
error reduced slightly further and R squared increased quite a bit
```{r}
model4$resample
```

```{r}
cv_10_fold <- trainControl(method = "cv", number = 10, savePredictions = TRUE)

model5 <- train(log(averageprice) ~ type + year + region + week + month, 
                data = avocado_tidy,
                trControl = cv_10_fold,
                method = "lm")

mean(model5$resample$RMSE)
mean(model5$resample$Rsquared)
```
```{r}
model5$resample
```

```{r}
cv_10_fold <- trainControl(method = "cv", number = 10, savePredictions = TRUE)

model6 <- train(log(averageprice) ~ type + year + region + week + month + region:type, 
                data = avocado_tidy,
                trControl = cv_10_fold,
                method = "lm")

mean(model6$resample$RMSE)
mean(model6$resample$Rsquared)
```

```{r}
cv_10_fold <- trainControl(method = "cv", number = 10, savePredictions = TRUE)

model7 <- train(log(averageprice) ~ type + year + region + week + month + region:type + region:month, 
                data = avocado_tidy,
                trControl = cv_10_fold,
                method = "lm")

mean(model7$resample$RMSE)
mean(model7$resample$Rsquared)
```

```{r}
cv_10_fold <- trainControl(method = "cv", number = 10, savePredictions = TRUE)

model8 <- train(log(averageprice) ~ type + year + region + week + month + region:type + region:week, 
                data = avocado_tidy,
                trControl = cv_10_fold,
                method = "lm")

mean(model8$resample$RMSE)
mean(model8$resample$Rsquared)
```

```{r}
model_best <- lm(log(averageprice) ~ type + year + region + week + month + region:type + region:week, data = avocado_tidy)
```

```{r}
broom::glance(model_best)
```

