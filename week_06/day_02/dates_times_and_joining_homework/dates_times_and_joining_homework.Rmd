---
title: "Dates, times and joining homework"
output: html_notebook
---

```{r}
library(dplyr)
library(dbplyr)
library(lubridate)
library(ggplot2)

date1 <- ymd_hms("2017-04-22 22:01:18")
date2 <- ymd_hms("2001-11-07 10:09:56")

mammals <- DBI::dbConnect(RSQLite::SQLite(), "mammals.sqlite")

src_dbi(mammals)

plots <- tbl(mammals, sql("SELECT * FROM plots"))
species <- tbl(mammals, sql("SELECT * FROM species"))
surveys <- tbl(mammals, sql("SELECT * FROM surveys"))
```

Extract the different components (year, month, mday, yday, wday) from the variable date1. Add the labels to the month and do not abbreviate the month labels.
```{r}
year(date1)
month(date1, label = TRUE, abbr = FALSE)
mday(date1)
yday(date1)
wday(date1)
```

Add 14 days to your date1 variable and store it in a variable called next_fortnight. Take away 10 years from your date2 variable, and store it in previous_decade.
```{r}
next_fortnight <- (date1 + days(14))
previous_decade <- (date2 - years(10))
next_fortnight
previous_decade
```

Create a variable called this_year which contains today’s date. Then create an interval object which uses this_year and the previous_decade variable you made above. Store it in interval_years.
```{r}
this_year <- ymd_hms(now())
this_year
interval_years <- interval(this_year, previous_decade)
interval_years
```

Change the time zone of both your date variables to “America/New_York”, and call them nyc_date1 and nyc_date2.
```{r}
nyc_date1 <- with_tz(this_year, tzone = "America/New_York")
nyc_date1

nyc_date2 <- with_tz(previous_decade, tzone = "America/New_York")
nyc_date2

```

Create a tibble called survey_tibble. Use the make_datetime function to create a new column within that tibble called full_date. (Hint: remember you can use the mutate function from yesterday to add new variables)

```{r}
surveys<- tbl(mammals, sql("SELECT * FROM surveys"))

survey_tibble <- surveys%>%
  collect() %>%
  mutate(full_date = make_datetime(year, month, day))
survey_tibble
```


Check what type the new full_date variable is.
```{r}
typeof(survey_tibble$full_date)
```

Convert the sex variable within survey_tibble to a logical variable. Save it in surveyor_sex.

```{r}
surveyor_sex <- as.logical(survey_tibble$sex)
surveyor_sex
```

Using the dbplyr package, join the species and surveys table, so that only those species who were surveyed are kept. Save it in a new tibble called all_species.

```{r}
species
surveys
library(dbplyr)
```
```{r}
all_species <- surveys %>%
  collect() %>%
  inner_join(species, by = "species_id", copy = TRUE)

all_species
```

Using the dpblyr package, implement a query (in R) that joins the species and survey tables together, and that returns the number of birds observed in each plot, each year. Hint : alongside the join functions, you can use some of the dplyr verbs we learnt about earlier in the week to filter, group, and count the data.
```{r}
number_of_birds_per_plot <- surveys %>%
  collect() %>%
  inner_join(species, by = "species_id", copy = TRUE) %>%
  filter(taxa == "Bird") %>%
  select(plot_id, taxa) %>%
  group_by(plot_id, taxa) %>%
  summarise(count_of_birds = n()) %>%
  arrange(desc(count_of_birds))

number_of_birds_per_plot
```
What would the equivalent query be in SQL

```{r}
#SELECT surveys.*, species.*
#           FROM surveys INNER JOIN species
#           ON species.species_id = species.id"
#           emm - not sure....
```


For the *extension* task, we will use the nycflights13 package data . This dataset contains all 336776 flights that departed from New York City in 2013. The data comes from the US Bureau of Transportation Statistics, and is documented in ?nycflights13. It contains 5 related tables: 
* airlines : airline names * airports : airport metadata * flights : flight time data for NYC departing flights * planes : plane metadata * weather : hourly weather data

You can find out more about the package here


```{r}
library(nycflights13)
```

Make a date-time column called departure_date from the year, month, day, hour, and minute variables in the flights tibble.

```{r}
flights <- flights %>%
  mutate(departure_date = make_datetime(year, month, day))
flights
```

Add the weather to the flights data by city of origin.

```{r}
flights2 <- flights %>%
  left_join(weather)
flights2
```

Add the location of the origin and destination (i.e. the lat and lon) to flights. Only keep those that have a location.
```{r}
flights_with_lat_lon <- flights2 %>%
    inner_join(select(airports, origin = faa, origin_lat = lat, origin_lon = lon),
    by = "origin"
  ) %>%
  inner_join(select(airports, dest = faa, dest_lat = lat, dest_lon = lon),
    by = "dest"
  )
flights_with_lat_lon
```


```{r}
flights_with_lat_lon %>%
  slice(1:125) %>%
  ggplot(aes(
    x = origin_lon, xend = dest_lon,
    y = origin_lat, yend = dest_lat
  )) +
  borders("state") +
  geom_segment(arrow = arrow(length = unit(0.1, "cm"))) +
  coord_quickmap() +
  labs(y = "Latitude", x = "Longitude")
```


Write a query which shows the mean delay of flights for each tailnumber and airline carrier, where the arrival delay was greater than 100 minutes.

```{r}
flights_with_lat_lon %>%
  select(tailnum, carrier, arr_delay) %>%
  filter(arr_delay > 100) %>%
  group_by(tailnum, carrier) %>%
  summarise(delayed = mean(arr_delay)) %>%
  arrange(desc(delayed))
```


Find the 10 most popular destinations to fly to, and then perform a join to find which flight went with those top 10 destinations.

```{r}
top_ten_dest <- flights_with_lat_lon %>%
  select(dest, carrier) %>%
  group_by(dest) %>%
  summarise(dest_count = n()) %>%
  arrange(desc(dest_count)) %>%
  slice(1:10)

top_ten_dest
```

```{r}
top_ten_dest %>%
  inner_join(flights, by = "dest") %>%
  filter(dest %in% c("ORD", "ATL", "LAX", "BOS", "MCO", "CLT", "SFO", "FLL", "MIA", "DCA")) %>%
  group_by(dest, flight) %>%
  summarise(dest_count = n()) %>%
  arrange(dest)
```

